---
- name: Ensure Himmelblau configuration directory exists
  ansible.builtin.file:
    path: /etc/himmelblau
    state: directory
    mode: '0755'
  become: true

- name: Deploy Himmelblau configuration
  ansible.builtin.template:
    src: himmelblau.conf.j2
    dest: /etc/himmelblau/himmelblau.conf
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: Restart himmelblau

- name: Check if SELinux is enabled
  ansible.builtin.command:
    cmd: getenforce
  register: selinux_status
  changed_when: false
  failed_when: false
  become: true

- name: Set SELinux to permissive mode
  ansible.builtin.command:
    cmd: setenforce 0
  become: true
  when: selinux_status.stdout == "Enforcing"
  changed_when: true

- name: Configure SELinux to boot in permissive mode
  ansible.builtin.lineinfile:
    path: /etc/selinux/config
    regexp: '^SELINUX='
    line: 'SELINUX=permissive'
    state: present
  become: true
  when: selinux_status.stdout == "Enforcing"

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes
  become: true

- name: Enable and start himmelblau daemon
  ansible.builtin.systemd:
    name: himmelblaud
    enabled: yes
    state: started
  become: true

- name: Wait for himmelblaud to be ready
  ansible.builtin.pause:
    seconds: 2

- name: Enable and start himmelblau-tasks service
  ansible.builtin.systemd:
    name: himmelblaud-tasks
    enabled: yes
    state: started
  become: true
  register: himmelblaud_tasks_start
  until: himmelblaud_tasks_start is succeeded
  retries: 3
  delay: 5

- name: Configure NSS for Himmelblau
  ansible.builtin.lineinfile:
    path: /etc/nsswitch.conf
    regexp: '^{{ item.key }}:'
    line: "{{ item.key }}:  files himmelblau"
    backrefs: no
  become: true
  loop:
    - { key: 'passwd' }
    - { key: 'group' }

- name: Check himmelblaud status before PAM configuration
  ansible.builtin.systemd:
    name: himmelblaud
    state: started
  become: true

- name: Configure PAM for Himmelblau
  ansible.builtin.command:
    cmd: aad-tool configure-pam
  become: true
  changed_when: true
  register: pam_config_result
  failed_when: false

- name: Display PAM configuration result
  ansible.builtin.debug:
    msg:
      - "PAM configuration return code: {{ pam_config_result.rc }}"
      - "stdout: {{ pam_config_result.stdout }}"
      - "stderr: {{ pam_config_result.stderr }}"

- name: Warn if PAM configuration failed
  ansible.builtin.debug:
    msg: "WARNING: aad-tool configure-pam returned non-zero. PAM may need manual configuration."
  when: pam_config_result.rc != 0

- name: Verify himmelblau services are running
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
  become: true
  loop:
    - himmelblaud
    - himmelblaud-tasks
  register: himmelblau_status

- name: Activate offline breakglass mode
  ansible.builtin.command:
    cmd: aad-tool offline-breakglass --ttl 24h
  become: true
  when: himmelblau_enable_offline | default(false)
  changed_when: true
  ignore_errors: true

- name: Wait for Himmelblau to be ready for enumeration
  ansible.builtin.pause:
    seconds: 5
  when: himmelblau_cache_users is defined and himmelblau_cache_users | length > 0

- name: Enumerate all users and groups for caching
  ansible.builtin.command:
    cmd: aad-tool enumerate
  become: true
  when: himmelblau_cache_users is defined and himmelblau_cache_users | length > 0
  changed_when: true
  register: enumerate_result
  ignore_errors: true

- name: Display enumeration result
  ansible.builtin.debug:
    msg: "User enumeration completed. Users cached for offline access."
  when:
    - enumerate_result is defined
    - enumerate_result.rc == 0


- name: Display enrollment instructions
  ansible.builtin.debug:
    msg:
      - "===================================================="
      - "Himmelblau has been installed and configured!"
      - "===================================================="
      - ""
      - "Himmelblau is now ready. Users can log in with their Azure Entra ID credentials."
      - "{% if himmelblau_enable_offline | default(false) %}Offline breakglass mode: ENABLED{% endif %}"
      - "{% if himmelblau_cache_users is defined and himmelblau_cache_users | length > 0 %}Cached users: {{ himmelblau_cache_users | join(', ') }}{% endif %}"
      - ""
      - "Useful commands:"
      - "  - Check status: sudo aad-tool status"
      - "  - Test auth: sudo aad-tool auth-test --name <username>@{{ himmelblau_domain }}"
      - "  - Enumerate users: sudo aad-tool enumerate"
      - "  - Clear cache: sudo aad-tool cache-clear"
      - "  - Activate offline mode: sudo aad-tool offline-breakglass --ttl 24h"
      - "  - Deactivate offline mode: sudo aad-tool offline-breakglass --ttl 0"
      - ""
      - "Users can now log in at the GDM login screen or via SSH using:"
      - "  Username: <username>@{{ himmelblau_domain }}"
      - "  Password: <Azure Entra ID password>"
      - ""
      - "===================================================="
