---
- name: Ensure Himmelblau configuration directory exists
  ansible.builtin.file:
    path: /etc/himmelblau
    state: directory
    mode: '0755'
  become: true

- name: Deploy Himmelblau configuration
  ansible.builtin.template:
    src: himmelblau.conf.j2
    dest: /etc/himmelblau/himmelblau.conf
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: Restart himmelblau

- name: Check if SELinux is enabled
  ansible.builtin.command:
    cmd: getenforce
  register: selinux_status
  changed_when: false
  failed_when: false
  become: true

- name: Set SELinux to permissive mode
  ansible.builtin.command:
    cmd: setenforce 0
  become: true
  when: selinux_status.stdout == "Enforcing"
  changed_when: true

- name: Configure SELinux to boot in permissive mode
  ansible.builtin.lineinfile:
    path: /etc/selinux/config
    regexp: '^SELINUX='
    line: 'SELINUX=permissive'
    state: present
  become: true
  when: selinux_status.stdout == "Enforcing"

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes
  become: true

- name: Enable and start himmelblau daemon
  ansible.builtin.systemd:
    name: himmelblaud
    enabled: yes
    state: started
  become: true

- name: Wait for himmelblaud to be ready
  ansible.builtin.pause:
    seconds: 2

- name: Enable and start himmelblau-tasks service
  ansible.builtin.systemd:
    name: himmelblaud-tasks
    enabled: yes
    state: started
  become: true
  register: himmelblaud_tasks_start
  until: himmelblaud_tasks_start is succeeded
  retries: 3
  delay: 5

- name: Configure NSS for Himmelblau
  ansible.builtin.replace:
    path: /etc/nsswitch.conf
    regexp: '^({{ item.key }}:\s+(?!.*himmelblau).*)$'
    replace: '\1 himmelblau'
  become: true
  loop:
    - { key: 'passwd' }
    - { key: 'group' }
    - { key: 'shadow' }

- name: Check himmelblaud status before PAM configuration
  ansible.builtin.systemd:
    name: himmelblaud
    state: started
  become: true

- name: Check current authselect profile
  ansible.builtin.command:
    cmd: authselect current --raw
  register: authselect_current
  changed_when: false
  failed_when: false
  become: true

- name: Opt out of authselect to allow manual PAM configuration
  ansible.builtin.command:
    cmd: authselect opt-out
  become: true
  changed_when: true
  when: authselect_current.rc == 0

- name: Add pam_himmelblau to system-auth
  ansible.builtin.lineinfile:
    path: /etc/pam.d/system-auth
    insertafter: '^auth\s+sufficient\s+pam_unix\.so'
    line: 'auth        sufficient                                   pam_himmelblau.so'
    state: present
  become: true

- name: Add pam_himmelblau account to system-auth
  ansible.builtin.lineinfile:
    path: /etc/pam.d/system-auth
    insertbefore: '^account\s+required\s+pam_unix\.so'
    line: 'account     sufficient                                   pam_himmelblau.so'
    state: present
  become: true

- name: Add pam_himmelblau to password-auth
  ansible.builtin.lineinfile:
    path: /etc/pam.d/password-auth
    insertafter: '^auth\s+sufficient\s+pam_unix\.so'
    line: 'auth        sufficient                                   pam_himmelblau.so'
    state: present
  become: true

- name: Add pam_himmelblau account to password-auth
  ansible.builtin.lineinfile:
    path: /etc/pam.d/password-auth
    insertbefore: '^account\s+required\s+pam_unix\.so'
    line: 'account     sufficient                                   pam_himmelblau.so'
    state: present
  become: true

- name: Add pam_himmelblau session to system-auth
  ansible.builtin.lineinfile:
    path: /etc/pam.d/system-auth
    insertafter: '^session\s+required\s+pam_unix\.so'
    line: 'session     optional                                     pam_himmelblau.so'
    state: present
  become: true

- name: Add pam_himmelblau session to password-auth
  ansible.builtin.lineinfile:
    path: /etc/pam.d/password-auth
    insertafter: '^session\s+required\s+pam_unix\.so'
    line: 'session     optional                                     pam_himmelblau.so'
    state: present
  become: true

- name: Add pam_mkhomedir to system-auth for home directory creation
  ansible.builtin.lineinfile:
    path: /etc/pam.d/system-auth
    insertafter: '^session\s+optional\s+pam_himmelblau\.so'
    line: 'session     required                                     pam_mkhomedir.so skel=/etc/skel umask=0077'
    state: present
  become: true

- name: Add pam_mkhomedir to password-auth for home directory creation
  ansible.builtin.lineinfile:
    path: /etc/pam.d/password-auth
    insertafter: '^session\s+optional\s+pam_himmelblau\.so'
    line: 'session     required                                     pam_mkhomedir.so skel=/etc/skel umask=0077'
    state: present
  become: true

- name: Verify himmelblau services are running
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
  become: true
  loop:
    - himmelblaud
    - himmelblaud-tasks
  register: himmelblau_status

- name: Activate offline breakglass mode
  ansible.builtin.command:
    cmd: aad-tool offline-breakglass --ttl 24h
  become: true
  when: himmelblau_enable_offline | default(false)
  changed_when: true
  ignore_errors: true

- name: Display enrollment instructions
  ansible.builtin.debug:
    msg:
      - "===================================================="
      - "Himmelblau has been installed and configured!"
      - "===================================================="
      - ""
      - "Himmelblau is now ready. Users can log in with their Azure Entra ID credentials."
      - "{% if himmelblau_enable_offline | default(false) %}Offline breakglass mode: ENABLED{% endif %}"
      - ""
      - "Useful commands:"
      - "  - Check status: sudo aad-tool status"
      - "  - Test auth: sudo aad-tool auth-test --name <username>@{{ himmelblau_domain }}"
      - ""
      - "Users can now log in at the GDM login screen or via SSH using:"
      - "  Username: <username>@{{ himmelblau_domain }}"
      - "  Password: <Azure Entra ID password>"
      - ""
      - "===================================================="
