---
- name: Check if device is a block device
  ansible.builtin.command:
    cmd: "test -b {{ luks_device }}"
  register: device_check
  changed_when: false
  failed_when: false
  become: true

- name: Verify device exists and is a block device
  ansible.builtin.fail:
    msg: "Device {{ luks_device }} does not exist or is not a block device. Please check the luks_device variable in host_vars. Run 'lsblk' to see available devices."
  when: device_check.rc != 0

- name: Check if LUKS device is already bound to TPM2
  ansible.builtin.command:
    cmd: "cryptsetup luksDump {{ luks_device }}"
  register: luks_dump
  changed_when: false
  failed_when: false
  become: true

- name: Find all LUKS devices on system
  ansible.builtin.shell:
    cmd: "blkid -t TYPE=crypto_LUKS -o device"
  register: luks_devices
  changed_when: false
  failed_when: false
  become: true
  when: luks_dump.rc != 0

- name: Check if device is a LUKS encrypted device
  ansible.builtin.fail:
    msg: |
      Device {{ luks_device }} is not a LUKS encrypted device.
      {% if luks_devices.stdout_lines | length > 0 %}

      However, these LUKS devices were found on your system:
      {{ luks_devices.stdout_lines | join('\n') }}

      Update the 'luks_device' variable in host_vars/localhost.yaml to use the correct device.
      {% else %}

      No LUKS devices found on this system.

      If Fedora was installed with encryption, check 'lsblk' to find the encrypted device.
      {% endif %}

      To encrypt {{ luks_device }} with LUKS:
      1. Back up all data
      2. Run: cryptsetup luksFormat {{ luks_device }}
      3. Restore data

      OR remove the disk_encryption role from playbook if encryption is not needed.
  when: luks_dump.rc != 0

- name: Bind LUKS device to TPM2
  ansible.builtin.shell:
    cmd: |
      echo -n "{{ luks_passphrase }}" | clevis luks bind -d {{ luks_device }} tpm2 '{"pcr_bank":"{{ tpm2_pcr_bank }}","pcr_ids":"{{ tpm2_pcr_ids }}"}'
  when: "'clevis' not in luks_dump.stdout"
  become: true
  register: clevis_bind
  environment:
    LC_ALL: C

- name: Display LUKS dump for verification
  ansible.builtin.command:
    cmd: "cryptsetup luksDump {{ luks_device }}"
  register: luks_verification
  changed_when: false
  become: true

- name: Show LUKS dump output
  ansible.builtin.debug:
    var: luks_verification.stdout_lines
