---
- name: Get user info from SSSD for primary users
  ansible.builtin.command:
    cmd: "id {{ item }}"
  loop: "{{ primary_users | default([]) }}"
  register: user_info
  changed_when: false
  failed_when: false
  become: true

- name: Parse user information
  ansible.builtin.set_fact:
    parsed_users: "{{ parsed_users | default([]) + [{'username': item.item, 'uid': item.stdout | regex_search('uid=(\\d+)', '\\1') | first, 'gid': item.stdout | regex_search('gid=(\\d+)', '\\1') | first, 'found': item.rc == 0}] }}"
  loop: "{{ user_info.results }}"
  when: item.rc == 0

- name: Add primary users to /etc/passwd for greeter visibility
  ansible.builtin.lineinfile:
    path: /etc/passwd
    regexp: '^{{ item.username }}:'
    line: "{{ item.username }}:x:{{ item.uid }}:{{ item.gid }}:{{ item.username }}:/home/{{ item.username }}:/bin/bash"
    state: present
  loop: "{{ parsed_users | default([]) }}"
  become: true
  when: item.found | default(false)

- name: Display configured users
  ansible.builtin.debug:
    msg: "Added {{ parsed_users | default([]) | length }} user(s) to /etc/passwd. They will appear in COSMIC Greeter login list."
  when: parsed_users is defined and parsed_users | length > 0

- name: Show individual user status
  ansible.builtin.debug:
    msg: "{{ item.username }}: {{ 'added to login screen (UID: ' + item.uid + ')' if item.found else 'NOT FOUND in AD - skipped' }}"
  loop: "{{ parsed_users | default([]) }}"
  when: parsed_users is defined
