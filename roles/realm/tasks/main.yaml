---
- name: Create systemd-resolved configuration directory
  ansible.builtin.file:
    path: /etc/systemd/resolved.conf.d
    state: directory
    mode: '0755'
  become: true

- name: Configure conditional DNS forwarding for AD domain
  ansible.builtin.copy:
    dest: /etc/systemd/resolved.conf.d/ad-domain.conf
    content: |
      [Resolve]
      DNS={{ ad_dns_servers | join(' ') }}
      Domains=~{{ ad_domain }}
    mode: '0644'
  become: true
  notify: restart systemd-resolved

- name: Enable and start systemd-resolved
  ansible.builtin.systemd:
    name: systemd-resolved
    enabled: true
    state: started
  become: true

- name: Flush handlers to ensure DNS is configured
  ansible.builtin.meta: flush_handlers

- name: Install OpenConnect for VPN
  ansible.builtin.dnf:
    name: openconnect
    state: present
  become: true
  when: vpn_enabled | default(false)

- name: Check if domain controllers are reachable
  ansible.builtin.command:
    cmd: ping -c 1 -W 2 {{ ad_dns_servers[0] }}
  register: dc_reachable
  failed_when: false
  changed_when: false
  when: vpn_enabled | default(false)

- name: Establish VPN connection if DCs not reachable
  ansible.builtin.shell:
    cmd: |
      echo "{{ vpn_password }}" | openconnect \
        --useragent="AnyConnect Linux_64 5.1.0" \
        --authgroup="{{ vpn_authgroup }}" \
        --user="{{ vpn_username }}" \
        --passwd-on-stdin \
        --background \
        {{ vpn_server }}
  become: true
  when:
    - vpn_enabled | default(false)
    - dc_reachable.rc != 0
  register: vpn_connect
  changed_when: vpn_connect.rc == 0
  no_log: true

- name: Wait for VPN connection to establish
  ansible.builtin.wait_for:
    timeout: 10
  when:
    - vpn_enabled | default(false)
    - dc_reachable.rc != 0
    - vpn_connect is changed

- name: Verify domain controller is now reachable via VPN
  ansible.builtin.command:
    cmd: ping -c 1 -W 2 {{ ad_dns_servers[0] }}
  register: dc_reachable_vpn
  changed_when: false
  when:
    - vpn_enabled | default(false)
    - dc_reachable.rc != 0

- name: Install required packages for AD realm join
  ansible.builtin.dnf:
    name:
      - realmd
      - sssd
      - oddjob
      - oddjob-mkhomedir
      - adcli
      - samba-common-tools
      - krb5-workstation
    state: present
  become: true

- name: Check if system is already joined to a realm
  ansible.builtin.command:
    cmd: realm list
  register: realm_status
  changed_when: false
  failed_when: false
  become: true

- name: Leave existing realm if joined
  ansible.builtin.shell:
    cmd: |
      echo "{{ ad_password }}" | realm leave {{ ad_domain }} --user={{ ad_user }}
  when: "ad_domain in realm_status.stdout"
  become: true
  no_log: false
  register: realm_leave
  failed_when: false

- name: Stop SSSD before cleanup
  ansible.builtin.systemd:
    name: sssd
    state: stopped
  become: true
  when: "ad_domain in realm_status.stdout or realm_leave is changed"
  failed_when: false

- name: Remove old keytab to prevent authentication issues
  ansible.builtin.file:
    path: /etc/krb5.keytab
    state: absent
  become: true
  when: "ad_domain in realm_status.stdout or realm_leave is changed"
  register: keytab_cleanup

- name: Clear SSSD cache to prevent stale data
  ansible.builtin.shell:
    cmd: find /var/lib/sss/db -mindepth 1 -delete
  become: true
  when: "ad_domain in realm_status.stdout or realm_leave is changed"
  changed_when: true
  failed_when: false

- name: Ensure SSSD db directory has correct ownership
  ansible.builtin.file:
    path: /var/lib/sss/db
    state: directory
    owner: sssd
    group: sssd
    mode: '0700'
  become: true
  when: "ad_domain in realm_status.stdout or realm_leave is changed"

- name: Join AD realm
  ansible.builtin.shell:
    cmd: |
      echo "{{ ad_password }}" | realm join {{ ad_domain }} --user={{ ad_user }} --computer-ou='{{ ad_computer_ou }}'
  when: "ad_domain not in realm_status.stdout or keytab_cleanup is not skipped"
  become: true
  register: realm_join
  environment:
    LC_ALL: C

- name: Restore SELinux context after realm join
  ansible.builtin.command:
    cmd: restorecon -R /var/lib/sss /etc/sssd
  become: true
  when: realm_join is changed
  changed_when: false

- name: Validate realm join was successful
  ansible.builtin.command:
    cmd: adcli testjoin
  become: true
  when: realm_join is changed
  changed_when: false
  register: testjoin_result
  failed_when: testjoin_result.rc != 0

- name: Display realm join validation result
  ansible.builtin.debug:
    msg: "Realm join validated successfully: {{ testjoin_result.stdout }}"
  when: realm_join is changed

- name: Stop SSSD after realm join to allow config modifications
  ansible.builtin.systemd:
    name: sssd
    state: stopped
  become: true
  when: realm_join is changed
  failed_when: false

- name: Remove config_file_version if present (not needed in newer SSSD)
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^config_file_version\s*='
    state: absent
  become: true
  when: realm_join is changed

- name: Configure SSSD for dynamic DNS updates
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^dyndns_update\s*='
    line: "dyndns_update = True"
    state: present
  become: true
  notify: restart sssd

- name: Configure SSSD for dynamic DNS PTR updates
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^dyndns_update_ptr\s*='
    line: "dyndns_update_ptr = True"
    state: present
  become: true
  notify: restart sssd

- name: Enable offline credentials caching
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^cache_credentials\s*='
    line: "cache_credentials = True"
    state: present
  become: true
  notify: restart sssd

- name: Allow offline authentication
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^krb5_store_password_if_offline\s*='
    line: "krb5_store_password_if_offline = True"
    state: present
  become: true
  notify: restart sssd

- name: Configure SSSD simple allow groups
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^simple_allow_groups\s*='
    line: "simple_allow_groups = {{ ad_allowed_group }}"
    state: present
  become: true
  notify: restart sssd
  when: ad_allowed_group is defined and ad_allowed_group != ""

- name: Change SSSD access provider to simple
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^access_provider\s*='
    line: "access_provider = simple"
    state: present
  become: true
  notify: restart sssd
  when: ad_allowed_group is defined and ad_allowed_group != ""

- name: Allow all AD users (no group restriction)
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^access_provider\s*='
    line: "access_provider = permit"
    state: present
  become: true
  notify: restart sssd
  when: ad_allowed_group is not defined or ad_allowed_group == ""

- name: Configure SSSD services for client
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^services\s*='
    line: "services = nss, pam"
    state: present
  become: true
  notify: restart sssd

- name: Enable automatic machine password renewal
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^ad_machine_account_password_renewal_opts\s*='
    line: "ad_machine_account_password_renewal_opts = 30:7"
    state: present
  become: true
  notify: restart sssd

- name: Set machine password renewal timeout
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^ad_maximum_machine_account_password_age\s*='
    line: "ad_maximum_machine_account_password_age = 30"
    state: present
  become: true
  notify: restart sssd

- name: Create SSSD systemd override directory
  ansible.builtin.file:
    path: /etc/systemd/system/sssd.service.d
    state: directory
    mode: '0755'
  become: true

- name: Configure SSSD to wait for network before starting
  ansible.builtin.copy:
    dest: /etc/systemd/system/sssd.service.d/wait-network.conf
    content: |
      [Unit]
      After=network-online.target
      Wants=network-online.target
    mode: '0644'
  become: true
  notify: reload systemd

- name: Enable SSSD service
  ansible.builtin.systemd:
    name: sssd
    enabled: true
    daemon_reload: true
  become: true

- name: Enable oddjobd service for home directory creation
  ansible.builtin.systemd:
    name: oddjobd
    enabled: true
    state: started
  become: true

- name: Grant sudo access to all AD users
  ansible.builtin.copy:
    dest: /etc/sudoers.d/ad-users
    content: |
      # Allow all AD domain users to use sudo
      %domain\ users@{{ ad_domain }} ALL=(ALL:ALL) ALL
    mode: '0440'
    validate: /usr/sbin/visudo -cf %s
  become: true

- name: Flush handlers to restart SSSD with new configuration
  ansible.builtin.meta: flush_handlers

- name: Disconnect VPN after realm join
  ansible.builtin.shell:
    cmd: killall -SIGINT openconnect
  become: true
  failed_when: false
  when:
    - vpn_enabled | default(false)
    - vpn_connect is defined
    - vpn_connect is changed
