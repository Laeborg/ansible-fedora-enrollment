---
- name: Create systemd-resolved configuration directory
  ansible.builtin.file:
    path: /etc/systemd/resolved.conf.d
    state: directory
    mode: '0755'
  become: true

- name: Configure conditional DNS forwarding for AD domain
  ansible.builtin.copy:
    dest: /etc/systemd/resolved.conf.d/ad-domain.conf
    content: |
      [Resolve]
      DNS={{ ad_dns_servers | join(' ') }}
      Domains=~{{ ad_domain }}
    mode: '0644'
  become: true
  notify: restart systemd-resolved

- name: Enable and start systemd-resolved
  ansible.builtin.systemd:
    name: systemd-resolved
    enabled: true
    state: started
  become: true

- name: Flush handlers to ensure DNS is configured
  ansible.builtin.meta: flush_handlers

- name: Install OpenConnect for VPN
  ansible.builtin.dnf:
    name: openconnect
    state: present
  become: true
  when: vpn_enabled | default(false)

- name: Check if domain controllers are reachable
  ansible.builtin.command:
    cmd: ping -c 1 -W 2 {{ ad_dns_servers[0] }}
  register: dc_reachable
  failed_when: false
  changed_when: false
  when: vpn_enabled | default(false)

- name: Establish VPN connection if DCs not reachable
  ansible.builtin.shell:
    cmd: |
      echo "{{ vpn_password }}" | openconnect \
        --useragent="AnyConnect Linux_64 5.1.0" \
        --authgroup="{{ vpn_authgroup }}" \
        --user="{{ vpn_username }}" \
        --passwd-on-stdin \
        --background \
        {{ vpn_server }}
  become: true
  when:
    - vpn_enabled | default(false)
    - dc_reachable.rc != 0
  register: vpn_connect
  changed_when: vpn_connect.rc == 0
  no_log: true

- name: Wait for VPN connection to establish
  ansible.builtin.wait_for:
    timeout: 10
  when:
    - vpn_enabled | default(false)
    - dc_reachable.rc != 0
    - vpn_connect is changed

- name: Verify domain controller is now reachable via VPN
  ansible.builtin.command:
    cmd: ping -c 1 -W 2 {{ ad_dns_servers[0] }}
  register: dc_reachable_vpn
  changed_when: false
  when:
    - vpn_enabled | default(false)
    - dc_reachable.rc != 0

- name: Install required packages for AD realm join
  ansible.builtin.dnf:
    name:
      - realmd
      - sssd
      - oddjob
      - oddjob-mkhomedir
      - adcli
      - samba-common-tools
      - krb5-workstation
    state: present
  become: true

- name: Check if system is already joined to a realm
  ansible.builtin.command:
    cmd: realm list
  register: realm_status
  changed_when: false
  failed_when: false
  become: true

- name: Leave existing realm if joined
  ansible.builtin.shell:
    cmd: |
      echo "{{ ad_password }}" | realm leave {{ ad_domain }} --user={{ ad_user }}
  when: "ad_domain in realm_status.stdout"
  become: true
  no_log: false
  register: realm_leave
  failed_when: false

- name: Join AD realm
  ansible.builtin.shell:
    cmd: |
      echo "{{ ad_password }}" | realm join {{ ad_domain }} --user={{ ad_user }} --computer-ou='{{ ad_computer_ou }}'
  when: "ad_domain not in realm_status.stdout or realm_leave is changed"
  become: true
  register: realm_join
  environment:
    LC_ALL: C

- name: Configure SSSD for dynamic DNS updates
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^dyndns_update\s*='
    line: "dyndns_update = True"
    state: present
  become: true
  notify: restart sssd

- name: Configure SSSD for dynamic DNS PTR updates
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^dyndns_update_ptr\s*='
    line: "dyndns_update_ptr = True"
    state: present
  become: true
  notify: restart sssd

- name: Configure SSSD simple allow groups
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^simple_allow_groups\s*='
    line: "simple_allow_groups = {{ ad_allowed_group }}"
    state: present
  become: true
  notify: restart sssd

- name: Change SSSD access provider to simple
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^access_provider\s*=\s*ad'
    line: "access_provider = simple"
    backrefs: false
  become: true
  notify: restart sssd

- name: Configure SSSD services for client
  ansible.builtin.lineinfile:
    path: /etc/sssd/sssd.conf
    regexp: '^services\s*='
    line: "services = nss, pam"
    state: present
  become: true
  notify: restart sssd

- name: Enable SSSD service
  ansible.builtin.systemd:
    name: sssd
    enabled: true
  become: true

- name: Enable oddjobd service for home directory creation
  ansible.builtin.systemd:
    name: oddjobd
    enabled: true
    state: started
  become: true

- name: Restart SSSD to apply all changes
  ansible.builtin.systemd:
    name: sssd
    state: restarted
  become: true
  when: realm_join is changed

- name: Debug - Display realm status
  ansible.builtin.command:
    cmd: realm list
  register: realm_list_output
  changed_when: false
  become: true
  when: realm_join is changed

- name: Debug - Show realm information
  ansible.builtin.debug:
    msg: "{{ realm_list_output.stdout_lines }}"
  when: realm_join is changed

- name: Debug - Test AD user lookup
  ansible.builtin.command:
    cmd: id {{ ad_user }}@{{ ad_domain }}
  register: ad_user_lookup
  changed_when: false
  failed_when: false
  become: true
  when: realm_join is changed

- name: Debug - Show AD user info
  ansible.builtin.debug:
    msg: "{{ ad_user_lookup.stdout }}"
  when:
    - realm_join is changed
    - ad_user_lookup.rc == 0

- name: Debug - Check SSSD configuration
  ansible.builtin.command:
    cmd: grep -E "simple_allow_groups|access_provider" /etc/sssd/sssd.conf
  register: sssd_config_check
  changed_when: false
  failed_when: false
  become: true
  when: realm_join is changed

- name: Debug - Show SSSD access configuration
  ansible.builtin.debug:
    msg: "{{ sssd_config_check.stdout_lines }}"
  when: realm_join is changed

- name: Debug - Verify DNS resolution
  ansible.builtin.command:
    cmd: nslookup {{ ad_domain }}
  register: dns_check
  changed_when: false
  failed_when: false
  when: realm_join is changed

- name: Debug - Show DNS results
  ansible.builtin.debug:
    msg: "{{ dns_check.stdout_lines }}"
  when: realm_join is changed

- name: Disconnect VPN after realm join
  ansible.builtin.shell:
    cmd: killall -SIGINT openconnect
  become: true
  failed_when: false
  when:
    - vpn_enabled | default(false)
    - vpn_connect is defined
    - vpn_connect is changed
