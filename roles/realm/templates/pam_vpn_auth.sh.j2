#!/bin/bash
# PAM pre-auth VPN connector
# This script attempts to establish VPN if DCs are unreachable
# Generated by Ansible - DO NOT EDIT MANUALLY

VPN_SERVER="{{ vpn_server }}"
VPN_AUTHGROUP="{{ vpn_authgroup }}"
DC_IP="{{ ad_dns_servers[0] }}"

# Check if DC is reachable
if ! ping -c 1 -W 2 "$DC_IP" &>/dev/null; then
    # DC not reachable, try VPN
    if [ -n "$PAM_USER" ] && [ "$PAM_TYPE" = "auth" ]; then
        # Extract domain user (remove @domain)
        VPN_USER="${PAM_USER%@*}"

        # Check if VPN already connected
        if ! pgrep -x openconnect > /dev/null; then
            # Read password from stdin (PAM provides it)
            echo "$PAM_AUTHTOK" | openconnect \
                --useragent="AnyConnect Linux_64 5.1.0" \
                --authgroup="$VPN_AUTHGROUP" \
                --user="$VPN_USER" \
                --passwd-on-stdin \
                --background \
                "$VPN_SERVER" &>/dev/null

            # Wait for VPN to establish
            sleep 5
        fi
    fi
fi

exit 0
