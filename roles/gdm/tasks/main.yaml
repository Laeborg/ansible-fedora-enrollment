---
- name: Install GDM display manager
  ansible.builtin.dnf:
    name: gdm
    state: present
  become: true

- name: Stop cosmic-greeter if running
  ansible.builtin.systemd:
    name: cosmic-greeter
    state: stopped
  become: true
  failed_when: false

- name: Disable cosmic-greeter if present
  ansible.builtin.systemd:
    name: cosmic-greeter
    enabled: no
  become: true
  failed_when: false

- name: Mask cosmic-greeter to prevent conflicts
  ansible.builtin.systemd:
    name: cosmic-greeter
    masked: yes
  become: true
  failed_when: false

- name: Set COSMIC as default session in GDM
  ansible.builtin.copy:
    content: |
      [daemon]
      DefaultSession=cosmic.desktop

      [greeter]
      IncludeAll=true
    dest: /etc/gdm/custom.conf
    mode: '0644'
  become: true

- name: Create dconf profile for GDM
  ansible.builtin.copy:
    content: |
      user-db:user
      system-db:gdm
    dest: /etc/dconf/profile/gdm
    mode: '0644'
  become: true

- name: Create GDM dconf database directory
  ansible.builtin.file:
    path: /etc/dconf/db/gdm.d
    state: directory
    mode: '0755'
  become: true

- name: Set COSMIC as default session via dconf
  ansible.builtin.copy:
    content: |
      [org/gnome/desktop/session]
      session-name='cosmic'
    dest: /etc/dconf/db/gdm.d/01-cosmic-default
    mode: '0644'
  become: true

- name: Update dconf database
  ansible.builtin.command:
    cmd: dconf update
  become: true
  changed_when: true

- name: Enable GDM
  ansible.builtin.systemd:
    name: gdm
    enabled: yes
  become: true

- name: Set default target to graphical
  ansible.builtin.command:
    cmd: systemctl set-default graphical.target
  become: true
  changed_when: true
